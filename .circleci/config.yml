version: 2.1

parameters:
  PMBOT:
    type: boolean
    default: false
  PMBOT_UPDATE_ID:
    type: string
    default: ''

jobs:
  update:
    docker:
      - image: pmbot/bot:latest
    steps:
      - checkout
      - run: pmbot update --url $PMBOT_URL --token $PMBOT_TOKEN

  build:
    docker:
      - image: node:12-alpine`
    steps:
      - checkout
      - run: npm install
      - run: npm run build

  webhook:
    docker:
      - image: node:12-alpine
    steps:
      - run:
          when: always
          command: pmbot nofity

workflows:

  update:
    when: << pipeline.parameters.PMBOT >>
    jobs:
      - update

  main:
    unless: << pipeline.parameters.PMBOT >>
    jobs:
      - build

orbs:
  webhook: eddiewebb/webhook@volatile

notify:
  webhooks:
    - url: http://localhost:3001/v1/ci/5f05e5891c0f29452c9d4bd8/circle?token=$PMBOT_TOKEN
